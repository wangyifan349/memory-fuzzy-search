import faiss
import numpy as np
from sentence_transformers import SentenceTransformer

MODEL_NAME = "sentence-transformers/all-MiniLM-L6-v2"
EMBED_DIM = 384
TOP_K = 5

model = SentenceTransformer(MODEL_NAME)

texts = [
"《挪威的森林》 — 村上春树（1987）：大学生渡边彻回忆青春，好友木月自杀后他与木月女友直子产生复杂依赖。直子因抑郁住进疗养院，渡边在内疚与关怀间与外向开朗的绿子相识并发展感情冲突。小说通过渡边在直子与绿子间的情感拉扯，呈现丧失、孤独与成长的痛苦过程，结尾留白，渡边继续面对生命与死亡的思索。",
"《海边的卡夫卡》 — 村上春树（2002）：15岁田村卡夫卡离家到四国试图逃避家庭诅咒并寻找身世，途中结识图书馆员与朋友，历经暴力与自我救赎。平行线是中年图书管理员中田，因童年事故失去记忆，被卷入寻找失踪猫与被暗势力追踪的事件。两条线索在象征与命运上互为呼应，卡夫卡最终面对过去并迈向新的开始。",
"《1Q84》 — 村上春树（2009–2010）：青豆与天吾在看似正常却隐含异变的世界被拉入名为“1Q84”的平行现实。青豆作为暗中执行任务的女性，天吾则因改写一本神秘书稿而被牵连，两人被宗教组织和神秘事件围绕。小说主线为两人穿越现实与记忆障壁互相寻找，揭示控制、孤独与救赎议题，结局带有开放性的重聚希望。",
"《且听风吟》 — 村上春树（1979）：第一人称叙述年轻人的日常与青春困惑，主人公与朋友在海边度过夜晚、喝酒、谈论爱情与未来。小说以轻松怀旧的语调描写朦胧的情感连接与小规模冒险，人物对话与细节刻画出青年期的惶惑与孤独。结尾以回忆体的感伤收束，奠定作者早期的风格基调。",
"《舞！舞！舞！》 — 村上春树（1988）：无名主人公回到东京追寻失踪的朋友与与过去有关的“羊男”线索。故事在都市酒店、边缘空间与超现实场景间穿插，主人公在追踪中遇见名为优子的女性并被卷入她的失落与记忆之中。小说围绕寻找与自我认同展开，最终主角在接受不完整答案的过程中继续前行。",
"《世界尽头与冷酷仙境》 — 村上春树（1985）：双线叙事：冷酷仙境线呈近未来信息控制与记忆移植，叙述者被卷入逃亡与身份被窃的危机；世界尽头线则描绘一座围墙小镇，居民失去影子与情感记忆。两条看似独立的故事在主题上互相映照，主人公在记忆与自我断裂中寻找复原之路，小说探讨意识、记忆与人格的分裂与重建。",
"《刺杀骑士团长》 — 村上春树（2017）：画家叙述者隐居山中，偶然发现一幅神秘画作并与一位声称骑士团长传说的女子与少年发生牵连。事件逐渐揭示关于作品起源、身份迷离与潜在暴力的多重线索，叙述者在追寻真相的过程中面对创作危机与自我认同。小说以象征与隐喻推进，结局模糊，强调艺术与现实的边界。",
"《寻羊冒险记》 — 村上春树（1982）：主人公接受任务寻找一只带有特殊标记的羊，旅程从札幌延伸到北海道深处。沿途遇到旧识、神秘组织与奇异人物，调查逐步揭露与现代生活空虚相关的更大谜团。主人公在追寻目标的过程中也在面对自身记忆与身份的裂隙，故事在现实与荒诞之间交织，结尾保留宿命感。",
"《百年孤独》 — 加西亚·马尔克斯（1967）：布恩迪亚家族在马孔多镇经历七代兴衰，家族成员常以相似姓名重复命运。奇异事件（幽灵、预言、自然异象）与现实历史并行，个人欲望、爱情与政治变迁交织成时间循环。小说以魔幻现实主义呈现孤独、宿命与记忆的反复，最终揭示家族与时间的终结性循环。",
"《追风筝的人》 — 卡勒德·胡赛尼（2003）：阿米尔与仆人哈桑童年在喀布尔一同放风筝，阿米尔目睹哈桑被侵犯却选择沉默。成年后离开阿富汗的阿米尔在美国生活却被愧疚缠绕，回国寻找救赎并照顾哈桑留下的儿子。回国途中面对战争创伤、家族秘密与自我赎罪，最终以承担与补偿作为弥补过去的方式。",
"《白夜行》 — 东野圭吾（2006）：从儿童时代共同经历一宗命案的男女主角，一个在光明处演戏，一个在暗处承受牺牲。故事跨越数十年，展示两人如何策划彼此的人生轨迹以隐藏真相，警方与周遭人物的调查逐渐逼近。小说以沉重笔触描绘牺牲、罪与扭曲的爱，结局揭示长期隐瞒下的人性代价。",
"《解忧杂货店》 — 东野圭吾（2011）：一家杂货店能回信过去写来的困惑信件，店主的回信在不同时代改变了写信者的人生走向。小说通过多条人物线并行，展示普通人在迷茫与绝望时因一封信而获得勇气或转机。若干故事最终交汇，揭示店铺存在的秘密與人与人之间简单善行的连锁影响。",
"《红楼梦》 — 曹雪芹（高鹗续，18世纪）：以贾宝玉、林黛玉与薛宝钗为核心，细致描绘贾府日常、婚姻与权势变迁。宝玉与黛玉情感深厚却多病多难，黛玉早逝；宝钗稳重入世，她们之间的情感纠葛推动家族悲剧。小说通过家族兴衰与人物命运展现封建礼教与世俗压力，结局以大观园衰败与家族散灭收束。",
"《活着》 — 余华（1993）：地主之子福贵因赌博败尽家产，家人接连遭遇病疫、意外与战争带来的死亡。福贵在失去妻儿后以平凡农民的身份继续生活，从痛苦中逐渐获得对生命的朴素理解。小说以简洁叙述记录苦难与坚韧，结尾以幸存者的平静与对生活的接受收尾。",
"《鹿鼎记》 — 金庸（1969–1972）：机智市井少年韦小宝凭口才与机缘成为皇帝身边的宠臣，穿梭于江湖门派、朝廷权谋与海盗势力间。故事围绕他的七位妻子、冒险任务与政治抉择展开，既有笑料也有惊险策略。最终韦小宝在忠诚与自由之间做出选择，故事以讽刺与幽默的方式呈现复杂人际与权力博弈。",
"《小王子》 — 圣埃克苏佩里（1943）：飞行员在撒哈拉遇见来自小行星的小王子，听他讲述离开星球后遇到的国王、酒鬼、商人与狐狸等人物。小王子与狐狸的驯养过程及对玫瑰的情感揭示责任、爱与成长的意义。结局中小王子选择返回星球，留下飞行员对童真與友情的怀念与反思。",
"《房思琪的初戀樂園》 — 林奕含（2017）：高中女生房思琪被受尊崇的老师以关怀之名诱导并长期性侵，她的学业、心理与青春被系统性摧毁。小说细腻呈现受害者的羞耻、孤立与绝望，以及家庭与社会在面对加害者时的沉默与无力。结尾强调创伤的持续与社会对权力侵害的忽视，作品具有强烈的控诉意味。",
"《嫌疑人X的献身》 — 东野圭吾（2005）：单亲母亲在自卫中导致一人死亡，邻居石神——天才数学家——为她设计看似完美的不在场证明与伪造证据。随着刑侦推进，数学天才与侦探之间展开智力对决，而石神对女方的深情与牺牲逐步显露。小说在悬疑解谜高潮中揭示献身的伦理意义与悲剧性后果。",
"《诺桑觉寺》 — 简·奥斯汀（1817）：芳汀娜（Fanny）在乡村成长，随家族前往诺桑觉寺经历庄园生活与宗教氛围，她目睹虚荣与社交礼仪的表里不一。小说通过她的视角描写婚姻选择、道德判断与自我成长，最后她在辨识真诚与虚伪后作出合适的婚姻决定。作品以讽刺与幽默探讨女性在社交场合的处境与自我实现。",
"《彼得·潘》 — J.M.巴里（1904/1911）：彼得·潘带温迪与她的兄弟飞向梦幻岛，孩子们与海盗、印第安人及失落男孩展开冒险。温迪在岛上扮演“母亲”角色，经历成长與责任的抉择。最终温迪返回现实世界长大成为母亲，彼得则选择留在永恒童年，故事在童真与成长间达到张力。",
"《追忆似水年华》 — 马塞尔·普鲁斯特（1913–1927）：叙述者通过对日常细节（如玛德莲蛋糕）的回忆展开长篇意识流叙事，回顾少年经历、恋爱、社交圈与艺术追求。小说细致描绘人物心理、嫉妒与时间对记忆的操控，叙述以内省与细腻感官记忆为主。全书以对时间流逝与记忆再现的深入探究为核心。"
]

embs = model.encode(texts, convert_to_numpy=True, normalize_embeddings=True).astype('float32')
index = faiss.IndexFlatIP(EMBED_DIM)
index.add(embs)

def search(query, top_k=TOP_K):
    q_emb = model.encode([query], convert_to_numpy=True, normalize_embeddings=True).astype('float32')
    D, I = index.search(q_emb, top_k)
    return [(texts[idx], float(score), int(idx)) for score, idx in zip(D[0], I[0]) if idx >= 0]

print("输入查询，Ctrl-C 或 Ctrl-D 退出。")
try:
    while True:
        q = input("query> ").strip()
        if not q:
            continue
        results = search(q, TOP_K)
        if not results:
            print("无结果")
            continue
        for i, (txt, score, idx) in enumerate(results, 1):
            print(f"{i}. [score={score:.4f}] (id={idx}) {txt}")
except (KeyboardInterrupt, EOFError):
    print("\n退出。")
